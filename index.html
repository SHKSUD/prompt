<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Content Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* ðŸŽ¨ THEME: Lovable Teal/Cyan Gradient */
        .hero-bg {
            background: linear-gradient(135deg, #0f766e 0%, #0ea5e9 100%);
            position: relative;
            overflow: hidden;
        }
        
        .hero-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            border-radius: 1.5rem;
        }
        
        .input-group label {
            font-weight: 600;
            color: #334155;
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom scrollbar for data tables */
        .data-table-container::-webkit-scrollbar {
            height: 8px;
        }

        .data-table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        .data-table-container::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }

    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- HEADER / INPUT SECTION -->
        <header class="hero-bg py-16 px-4 sm:px-6 lg:px-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2 tracking-tight">
                    SEO Content Studio
                </h1>
                <p class="text-white text-opacity-80 text-xl mb-8">
                    Generate high-value content topics and structured drafts using Gemini.
                </p>

                <!-- INPUT CARD -->
                <div class="bg-white card p-6 sm:p-8 space-y-6">
                    <!-- Target Audience -->
                    <div class="input-group">
                        <label for="audience" class="block text-sm mb-2">Target Audience/Niche</label>
                        <input type="text" id="audience" value="small business owners interested in local SEO" placeholder="e.g., developers learning React, dog owners in NYC"
                            class="w-full border border-slate-300 p-3 rounded-xl focus:ring-cyan-500 focus:border-cyan-500 transition duration-150"
                            oninput="clearData()">
                    </div>

                    <!-- Keywords -->
                    <div class="input-group">
                        <label for="keywords" class="block text-sm mb-2">Primary Keywords (comma separated)</label>
                        <input type="text" id="keywords" value="local SEO, Google Business Profile, geo-fencing" placeholder="e.g., best coffee, AI tools, home workout routine"
                            class="w-full border border-slate-300 p-3 rounded-xl focus:ring-cyan-500 focus:border-cyan-500 transition duration-150"
                            oninput="clearData()">
                    </div>
                    
                    <!-- Tone of Voice -->
                    <div class="input-group">
                        <label for="tone" class="block text-sm mb-2">Tone of Voice</label>
                        <select id="tone" 
                            class="w-full border border-slate-300 p-3 rounded-xl focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 appearance-none bg-white"
                            onchange="clearData()">
                            <option value="authoritative">Authoritative and Professional</option>
                            <option value="friendly">Friendly and Conversational</option>
                            <option value="witty">Witty and Sarcastic</option>
                        </select>
                    </div>

                    <!-- Generate Button -->
                    <button id="generateTopicsBtn" onclick="generateTopics()"
                        class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-xl transition duration-300 flex items-center justify-center disabled:opacity-50"
                        disabled>
                        <span id="loadingSpinner" class="hidden spinner mr-3"></span>
                        <span id="buttonText">Generate Topics & Meta Data</span>
                    </button>
                    
                    <p id="errorMsg" class="text-red-600 font-medium text-sm text-center hidden"></p>
                </div>
                <!-- /INPUT CARD -->
            </div>
        </header>

        <!-- MAIN CONTENT SECTION (RESULTS) -->
        <main class="flex-grow py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-6xl mx-auto">
                
                <!-- TOPICS TABLE -->
                <section id="topicResults" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">
                        Generated SEO Content Topics
                    </h2>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <p class="text-sm text-slate-600">Select a topic to generate a detailed content structure.</p>
                        <div class="flex space-x-2">
                            <button onclick="copyToClipboard('csv')" class="text-xs font-medium text-cyan-700 hover:text-cyan-900 bg-cyan-100 px-3 py-1.5 rounded-lg transition duration-150">Copy CSV</button>
                            <button onclick="copyToClipboard('json')" class="text-xs font-medium text-cyan-700 hover:text-cyan-900 bg-cyan-100 px-3 py-1.5 rounded-lg transition duration-150">Copy JSON</button>
                        </div>
                    </div>
                    

                    <div class="data-table-container overflow-x-auto bg-white card shadow-lg">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead>
                                <tr class="bg-slate-50">
                                    <th class="p-5 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-5/12">Topic & Slug</th>
                                    <th class="p-5 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-4/12">Meta Description</th>
                                    <th class="p-5 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-1/12">Difficulty</th>
                                    <th class="p-5 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-1/12">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="topicTableBody" class="divide-y divide-slate-100">
                                <!-- Topic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- CONTENT STRUCTURE / DRAFT SECTION -->
                <section id="draftSection" class="mt-12 hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center space-x-3">
                        <span id="draftTitle">Content Structure: [Selected Topic]</span>
                        <span class="text-sm text-cyan-600 bg-cyan-50 px-3 py-1 rounded-full font-mono hidden" id="draftSlug"></span>
                    </h2>

                    <!-- TABS: STRUCTURE / DRAFT -->
                    <div class="flex space-x-2 border-b border-slate-200 mb-6">
                        <button id="structureTab" class="py-2 px-4 text-sm font-medium border-b-2 border-cyan-600 text-cyan-600 transition duration-150" onclick="showView('structure')">
                            SEO Structure
                        </button>
                        <button id="draftTab" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 transition duration-150" onclick="showView('draft')">
                            First Draft
                        </button>
                    </div>

                    <!-- GENERATE STRUCTURE BUTTON -->
                    <button id="generateStructureBtn" onclick="generateStructure()"
                        class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 flex items-center justify-center disabled:opacity-50"
                        disabled>
                        <span id="loadingSpinnerStructure" class="hidden spinner mr-3"></span>
                        <span id="buttonTextStructure">Generate Detailed Content Structure</span>
                    </button>
                    
                    <!-- STRUCTURE VIEW -->
                    <div id="structureView" class="mt-6 bg-white card p-6 sm:p-8 space-y-4 whitespace-pre-wrap text-slate-700 text-sm overflow-x-auto">
                        <!-- Structure content will be injected here -->
                    </div>

                    <!-- DRAFT VIEW -->
                    <div id="draftView" class="mt-6 hidden">
                        <button id="generateDraftBtn" onclick="generateDraft()"
                            class="bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 mb-6 flex items-center justify-center disabled:opacity-50"
                            disabled>
                            <span id="loadingSpinnerDraft" class="hidden spinner mr-3"></span>
                            <span id="buttonTextDraft">Generate Full Content Draft</span>
                        </button>

                        <div id="draftContent" class="bg-white card p-6 sm:p-8 space-y-4 whitespace-pre-wrap text-slate-800 leading-relaxed text-base">
                            <!-- Draft content will be injected here -->
                        </div>
                    </div>
                </section>

            </div>
        </main>

        <!-- FOOTER -->
        <footer class="text-center py-6 text-sm text-slate-500 border-t border-slate-100 mt-12">
            Powered by Gemini API (via Vercel Proxy) | Designed for SEO content ideation.
        </footer>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let generatedData = [];
        let selectedTopic = null;
        let selectedStructure = null;
        let lastErrorDetails = "";
        
        // --- CORE UTILITIES ---

        // NEW: Robustly cleans text returned from the LLM to isolate pure JSON content.
        function cleanJsonString(str) {
            if (!str) return "";
            let cleaned = str.trim();

            // 1. Remove Markdown code fences (e.g., ```json or ```)
            // Check for and remove the opening fence (and any optional language identifier)
            if (cleaned.startsWith('```')) {
                const firstNewline = cleaned.indexOf('\n');
                if (firstNewline !== -1) {
                    cleaned = cleaned.substring(firstNewline + 1).trim();
                } else {
                    // Just removes the starting ``` if it's on the first line
                    cleaned = cleaned.substring(3).trim(); 
                }
            }

            // Remove the closing fence if present
            if (cleaned.endsWith('```')) {
                cleaned = cleaned.substring(0, cleaned.lastIndexOf('```')).trim();
            }

            // 2. Isolate the JSON object/array using index of first/last brace/bracket
            const firstBracket = cleaned.indexOf('{');
            const firstBrace = cleaned.indexOf('[');
            let start = Math.min(
                firstBracket === -1 ? Infinity : firstBracket,
                firstBrace === -1 ? Infinity : firstBrace
            );

            const lastBracket = cleaned.lastIndexOf('}');
            const lastBrace = cleaned.lastIndexOf(']');
            let end = Math.max(
                lastBracket === -1 ? -Infinity : lastBracket,
                lastBrace === -1 ? -Infinity : lastBrace
            );

            if (start !== Infinity && end !== -Infinity && end > start) {
                // Ensure we capture the opening and closing structure
                cleaned = cleaned.substring(start, end + 1);
            }
            
            return cleaned;
        }

        function showLoading(text) {
            const btn = document.getElementById(selectedTopic ? 'generateStructureBtn' : 'generateTopicsBtn');
            const spinnerId = selectedTopic ? 'loadingSpinnerStructure' : 'loadingSpinner';
            const textId = selectedTopic ? 'buttonTextStructure' : 'buttonText';

            if (selectedTopic === null && document.getElementById('draftView').classList.contains('active')) {
                // Special case for Draft button
                document.getElementById('loadingSpinnerDraft').classList.remove('hidden');
                document.getElementById('buttonTextDraft').textContent = text;
                document.getElementById('generateDraftBtn').disabled = true;
                return;
            }

            document.getElementById(spinnerId).classList.remove('hidden');
            document.getElementById(textId).textContent = text;
            btn.disabled = true;
            document.getElementById('errorMsg').classList.add('hidden');
        }

        function hideLoading(isDraft = false) {
            if (isDraft) {
                document.getElementById('loadingSpinnerDraft').classList.add('hidden');
                document.getElementById('buttonTextDraft').textContent = 'Generate Full Content Draft';
                document.getElementById('generateDraftBtn').disabled = false;
                return;
            }
            
            const btn = document.getElementById(selectedTopic ? 'generateStructureBtn' : 'generateTopicsBtn');
            const spinnerId = selectedTopic ? 'loadingSpinnerStructure' : 'loadingSpinner';
            const textId = selectedTopic ? 'buttonTextStructure' : 'buttonText';
            
            document.getElementById(spinnerId).classList.add('hidden');
            document.getElementById(textId).textContent = selectedTopic ? 'Generate Detailed Content Structure' : 'Generate Topics & Meta Data';
            btn.disabled = false;
        }
        
        function showError(message) {
            const msgElement = document.getElementById('errorMsg');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            console.error("Application Error:", message);
            if(lastErrorDetails) {
                console.error("API Details:", lastErrorDetails);
            }
        }
        
        function clearData() {
            generatedData = [];
            selectedTopic = null;
            selectedStructure = null;
            document.getElementById('topicTableBody').innerHTML = '';
            document.getElementById('topicResults').classList.add('hidden');
            document.getElementById('draftSection').classList.add('hidden');
            document.getElementById('generateTopicsBtn').disabled = false;
        }

        // --- FETCH LOGIC ---

        async function apiCall(prompt, mode, systemInstruction, responseSchema = null) {
            const generationConfig = {};
            
            if (responseSchema) {
                generationConfig.responseMimeType = "application/json";
                generationConfig.responseSchema = responseSchema;
            }

            const payload = {
                prompt: prompt,
                mode: mode,
                config: {
                    systemInstruction: systemInstruction,
                    generationConfig: generationConfig
                }
            };
            
            lastErrorDetails = ""; // Reset error details before new call

            try {
                const response = await fetch('/api/gemini-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({ 
                        error: 'Unknown server error', 
                        details: response.statusText 
                    }));
                    lastErrorDetails = errorJson.details || errorJson.error || response.statusText;
                    throw new Error(`API Proxy Error (${response.status}): ${errorJson.error || errorJson.details}`);
                }

                const responseText = await response.text();
                
                if (responseSchema) {
                    // If JSON is expected, clean it robustly
                    const cleanedText = cleanJsonString(responseText);
                    try {
                        return JSON.parse(cleanedText);
                    } catch (e) {
                        lastErrorDetails = `Malformed JSON content received:\n${responseText}`;
                        throw new Error("Topic Generation Error: JSON parsing failed. The proxy returned malformed content.");
                    }
                }
                
                // For non-JSON responses (structure/draft), return raw text
                return responseText;

            } catch (error) {
                throw error;
            }
        }

        // --- APP FLOW FUNCTIONS ---

        async function generateTopics() {
            const audience = document.getElementById('audience').value.trim();
            const keywords = document.getElementById('keywords').value.trim();
            const tone = document.getElementById('tone').value;
            
            if (!audience || !keywords) {
                showError("Please fill in both Audience and Keywords.");
                return;
            }

            showLoading("Generating SEO Topics...");
            
            const systemPrompt = `You are a world-class SEO strategist and content generation AI. Your task is to generate five high-value blog post topics, slugs, meta descriptions, estimated difficulty (Easy, Medium, Hard), and estimated monthly search volume (Low, Medium, High). The tone must be ${tone}. The entire output MUST be a JSON array of objects, strictly following the provided schema, with no additional text or markdown formatting outside the JSON array.`;

            const prompt = `Generate 5 blog post ideas for the target audience: "${audience}", focusing on these primary keywords: ${keywords}.`;
            
            const topicsSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        title: { type: "STRING", description: "The title of the blog post, optimized for SEO." },
                        slug: { type: "STRING", description: "The URL slug (all lowercase, hyphenated, no special characters)." },
                        meta: { type: "STRING", description: "A concise, compelling meta description (under 160 characters)." },
                        difficulty: { type: "STRING", description: "Estimated keyword difficulty (Low, Medium, or High)." },
                        volume: { type: "STRING", description: "Estimated monthly search volume (Low, Medium, or High)." }
                    },
                    required: ["title", "slug", "meta", "difficulty", "volume"]
                }
            };
            
            try {
                const topics = await apiCall(prompt, 'topics', systemPrompt, topicsSchema);
                
                if (Array.isArray(topics) && topics.length > 0) {
                    generatedData = topics;
                    renderTopics(topics);
                } else {
                    showError("Generation failed or returned an empty list of topics.");
                }
                
            } catch (error) {
                showError(`ðŸš¨ Topic Generation Error: ${error.message}.`);
            } finally {
                hideLoading();
            }
        }

        function renderTopics(data) {
            const tbody = document.getElementById('topicTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-5 text-center text-slate-500">No topics generated.</td></tr>';
                document.getElementById('topicResults').classList.remove('hidden');
                return;
            }

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-cyan-50 transition duration-150';
                row.onclick = () => selectTopic(index);
                
                let diffColor;
                switch(item.difficulty.toLowerCase()) {
                    case 'easy': diffColor = 'bg-green-100 text-green-700'; break;
                    case 'medium': diffColor = 'bg-yellow-100 text-yellow-700'; break;
                    case 'hard': diffColor = 'bg-red-100 text-red-700'; break;
                    default: diffColor = 'bg-slate-100 text-slate-700';
                }

                row.innerHTML = `
                    <td class="p-5 align-top">
                        <div class="font-bold text-slate-800 text-base mb-1">${item.title}</div>
                        <div class="text-xs font-mono text-cyan-600 bg-cyan-50 inline-block px-2 py-1 rounded">/${item.slug}</div>
                    </td>
                    <td class="p-5 align-top text-slate-600 leading-relaxed">${item.meta}</td>
                    <td class="p-5 align-top">
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${diffColor}">${item.difficulty}</span>
                    </td>
                    <td class="p-5 align-top text-slate-600 font-medium">${item.volume}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('topicResults').classList.remove('hidden');
            document.getElementById('draftSection').classList.add('hidden');
            selectedTopic = null; // Clear previous selection
        }

        function selectTopic(index) {
            selectedTopic = generatedData[index];
            selectedStructure = null;
            
            // Highlight the selected row
            document.querySelectorAll('#topicTableBody tr').forEach((row, i) => {
                row.classList.toggle('bg-cyan-100', i === index);
                row.classList.toggle('bg-white', i !== index);
            });

            // Update Draft Section Header
            document.getElementById('draftTitle').textContent = `Content Structure: ${selectedTopic.title}`;
            document.getElementById('draftSlug').textContent = `/${selectedTopic.slug}`;
            document.getElementById('draftSlug').classList.remove('hidden');

            // Reset Structure and Draft views
            document.getElementById('structureView').innerHTML = '<p class="text-slate-500">Click "Generate Detailed Content Structure" above to begin.</p>';
            document.getElementById('draftContent').innerHTML = '<p class="text-slate-500">Generate the structure first, then click the "First Draft" tab to generate the full article.</p>';
            document.getElementById('draftView').classList.add('hidden'); // Hide draft tab content initially
            document.getElementById('generateDraftBtn').disabled = true;

            // Show Structure tab and activate its button
            showView('structure');
            document.getElementById('generateStructureBtn').disabled = false;
            
            document.getElementById('draftSection').classList.remove('hidden');
        }

        async function generateStructure() {
            if (!selectedTopic) return;

            showLoading("Analyzing SERP & Planning Structure...", false);
            document.getElementById('structureView').innerHTML = `<div class="flex items-center space-x-2 text-cyan-600"><div class="spinner"></div><span>Generating structure...</span></div>`;
            document.getElementById('generateDraftBtn').disabled = true;
            document.getElementById('draftContent').innerHTML = '<p class="text-slate-500">Draft generation awaits structure completion.</p>';

            const audience = document.getElementById('audience').value.trim();
            const tone = document.getElementById('tone').value;

            const systemPrompt = `You are a highly skilled SEO writer and content planner. Your task is to generate a detailed, comprehensive, and high-quality content structure (outline) for a blog post. The output MUST be in markdown format. Use H2, H3, and bullet points. Do not include a final H1 title, as the title is already provided. The tone must be ${tone}.`;
            
            const prompt = `Based on this SEO topic: "${selectedTopic.title}", and the target audience: "${audience}", generate a comprehensive content structure. Include a strong introduction, 4-6 main H2 sections, and detailed H3 sub-sections or bullet points under each H2 to guide a 1,500-2,000 word article. The meta description is: "${selectedTopic.meta}". Focus on the keywords: "${document.getElementById('keywords').value.trim()}"`;

            try {
                const structureText = await apiCall(prompt, 'structure', systemPrompt);
                selectedStructure = structureText;
                document.getElementById('structureView').innerHTML = renderMarkdown(structureText);
                document.getElementById('generateDraftBtn').disabled = false; // Enable draft button
            } catch (error) {
                showError(`ðŸš¨ Structure Generation Error: ${error.message}.`);
                document.getElementById('structureView').innerHTML = `<p class="text-red-600">Failed to generate structure. ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }
        
        async function generateDraft() {
            if (!selectedTopic || !selectedStructure) {
                showError("Please generate the content structure first.");
                return;
            }

            showLoading("Writing Full Draft (this may take 30-60 seconds)...", true);
            document.getElementById('draftContent').innerHTML = `<div class="flex items-center space-x-2 text-fuchsia-600"><div class="spinner"></div><span>Writing draft...</span></div>`;

            const audience = document.getElementById('audience').value.trim();
            const tone = document.getElementById('tone').value;
            
            const systemPrompt = `You are a professional content writer. Your task is to write a full, compelling, and high-quality first draft of a blog post, strictly following the provided content structure. The tone must be ${tone} and perfectly match the target audience: "${audience}". The entire output must be in plain markdown (using ** for bold, # for headers, - for lists, etc.). DO NOT include any introductory or concluding comments outside the article text.`;
            
            // Pass the entire structure/outline to the model as the prompt
            const prompt = `Write a 1,500-2,000 word article based on the following title and structure. Title: "${selectedTopic.title}". Structure:\n\n---\n${selectedStructure}\n---`;

            try {
                const draftText = await apiCall(prompt, 'draft', systemPrompt);
                document.getElementById('draftContent').innerHTML = renderMarkdown(draftText);
                
            } catch (error) {
                showError(`ðŸš¨ Draft Generation Error: ${error.message}.`);
                document.getElementById('draftContent').innerHTML = `<p class="text-red-600">Failed to generate draft. ${error.message}</p>`;
            } finally {
                hideLoading(true);
            }
        }

        // --- UI UTILITIES ---

        function showView(view) {
            document.getElementById('structureView').classList.add('hidden');
            document.getElementById('draftView').classList.add('hidden');
            document.getElementById('structureTab').classList.remove('border-cyan-600', 'text-cyan-600');
            document.getElementById('draftTab').classList.remove('border-cyan-600', 'text-cyan-600');
            document.getElementById('structureTab').classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700');
            document.getElementById('draftTab').classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700');

            if (view === 'structure') {
                document.getElementById('structureView').classList.remove('hidden');
                document.getElementById('structureTab').classList.add('border-cyan-600', 'text-cyan-600');
                document.getElementById('structureTab').classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700');
                document.getElementById('structureTab').classList.add('active');
                document.getElementById('draftTab').classList.remove('active');
            } else if (view === 'draft') {
                document.getElementById('draftView').classList.remove('hidden');
                document.getElementById('draftTab').classList.add('border-cyan-600', 'text-cyan-600');
                document.getElementById('draftTab').classList.remove('border-transparent', 'text-slate-500', 'hover:text-slate-700');
                document.getElementById('draftTab').classList.add('active');
                document.getElementById('structureTab').classList.remove('active');
            }
        }

        // Simple markdown to HTML conversion (for displaying output cleanly)
        function renderMarkdown(markdown) {
            let html = markdown || '';
            
            // Replace headers
            html = html.replace(/^###\s*(.*)$/gm, '</h3><h4>$1</h4>'); // H4 for H3 in outline
            html = html.replace(/^##\s*(.*)$/gm, '</h3><h3 class="text-xl font-bold mt-6 mb-3 text-slate-800">$1</h3>'); // H3 for H2
            
            // Replace lists (simple bullets)
            html = html.replace(/^- (.*)$/gm, '<li class="ml-4 list-disc">$1</li>');
            html = html.replace(/<li class="ml-4 list-disc">[\s\S]*?<\/li>/g, function(match) {
                if (match.includes('<ul')) return match; // Avoid double nesting if nested lists were already processed
                return '<ul class="list-inside mb-4 space-y-1">' + match + '</ul>';
            });
            
            // Bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Ensure paragraphs are wrapped
            html = html.split('\n\n').map(p => {
                const trimmed = p.trim();
                if (trimmed && !trimmed.startsWith('<h') && !trimmed.startsWith('<ul') && !trimmed.startsWith('<div')) {
                    return `<p class="mb-4">${trimmed}</p>`;
                }
                return p;
            }).join('\n');
            
            // Clean up potentially empty tags or extra newlines
            return html.replace(/<p class="mb-4">\s*<\/p>/g, '').trim();
        }

        window.copyToClipboard = function(format) {
            if (!generatedData.length) return;
            let text = "";
            if (format === 'json') {
                text = JSON.stringify(generatedData, null, 2);
            } else {
                // CSV format
                text = "Title,Slug,Meta Description,Difficulty,Volume\n";
                generatedData.forEach(d => {
                    // Basic CSV sanitation: wrap fields in quotes and escape internal quotes
                    text += `"${d.title.replace(/"/g,'""')}",${d.slug},"${d.meta.replace(/"/g,'""')}",${d.difficulty},${d.volume}\n`;
                });
            }

            try {
                // Use execCommand('copy') for better compatibility in iframe environments
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                
                // Simple visual confirmation
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = "Copied!";
                setTimeout(() => { btn.textContent = originalText; }, 1500);

            } catch (err) {
                showError('Failed to copy text. Please copy manually from the console.');
                console.warn('Could not copy automatically. Data:', text);
            }
        }
        
        // Initial setup check
        document.addEventListener('DOMContentLoaded', () => {
            const audienceInput = document.getElementById('audience');
            const keywordsInput = document.getElementById('keywords');
            const button = document.getElementById('generateTopicsBtn');
            
            function checkInputs() {
                if (audienceInput.value.trim() && keywordsInput.value.trim()) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
            }

            audienceInput.addEventListener('input', checkInputs);
            keywordsInput.addEventListener('input', checkInputs);
            
            checkInputs(); // Run on load
        });

    </script>
</body>
</html>

